title: 格式化字符串基础知识
author: 7h4mid4
tags:
  - pwn
  - 格式化字符串
  - CTF
categories:
  - 学习
  - CTF
date: 2019-08-04 13:27:00
---
参考文章： https://blog.csdn.net/qq_43394612/article/details/84900668



#### 漏洞发生机理

假设一个字符串str，一般来说，使用printf的时候，我们的用法是：printf("%s", str)，但是有人是这样用的printf(str)，这种情况下我们还能输出吗？答案是可以，因为printf函数的格式，str会被当做format参数，我们知道，使用printf的时候，format参数中的字符串是可以被输出的，但是如果这串字符串中有基本的格式化字符串参数(%s, %n, %x, %p等，下面做个介绍)，那么这些内容就会被当做基本的格式化字符串参数来处理，这样就出现了可利用的漏洞。






#### 常用基本的格式化字符串参数介绍：


        %c：输出字符，配上%n可用于向指定地址写数据。
    
        %d：输出十进制整数，配上%n可用于向指定地址写数据。
        
        %x：输出16进制数据，如%i$x表示要泄漏偏移i处4字节长的16进制数据，%i$lx表示要泄漏偏移i处8字节长的16进制数据，32bit和64bit环境下一样。

        %p：输出16进制数据，与%x基本一样，只是附加了前缀0x，在32bit下输出4字节，在64bit下输出8字节，可通过输出字节的长度来判断目标环境是32bit还是64bit。
        
        %s：输出的内容是字符串，即将偏移处指针指向的字符串输出，如%i$s表示输出偏移i处地址所指向的字符串，在32bit和64bit环境下一样，可用于读取GOT表等信息。

        %n：将%n之前printf已经打印的字符个数赋值给偏移处指针所指向的地址位置，如%100×10$n表示将0x64写入偏移10处保存的指针所指向的地址（4字节），而%$hn表示写入的地址空间为2字节，%$hhn表示写入的地址空间为1字节，%$lln表示写入的地址空间为8字节，在32bit和64bit环境下一样。有时，直接写4字节会导致程序崩溃或等候时间过长，可以通过%$hn或%$hhn来适时调整。
        
        
        除了%n,还有%hn，%hhn，%lln，分别为写入目标空间2字节，1字节，8字节。 注意是对应参数（这个参数是指针）的对应的地址开始起几个字节。不要觉得%lln，取的是8个字节的指针，%n取的就是4个字节的指针，取的是多少字节的指针只跟 程序的位数有关，如果是32位的程序，%n取的就是4字节指针，64位取的就是8字节指针，这是因为不同位数的程序，每个参数对应的字节数是不同的。
        
        
举例如下：

![upload successful](/images/pasted-0.png)

        

printf函数并不知道参数个数，它的内部有个指针，用来索检格式化字符串。对于特定类型%，就去取相应参数的值，直到索检到格式化字符串结束。所以尽管没有参数，上面的代码也会将format string 后面的内存当做参数以16进制输出。这样就会造成内存泄露。
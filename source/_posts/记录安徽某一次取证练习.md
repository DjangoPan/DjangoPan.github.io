title: 安徽取证大比武个人Writeup
author: 7h4mid4
date: 2019-09-25 15:14:50
tags:
---
### 案件背景：

经市民举报，近期经常受到中介的骚扰，办案单位进而对被举报的中介进行审讯，发现他们手上的信息来源都来自于某网站的后台管理员陈某。经查受骚扰的市民都有在该网站注册过信息。锁定嫌疑人后，办案人员迅速对嫌疑人进行了控制，经了解，陈某6月24日中午已经从该公司离职，其声称没办法接触到服务器更不能拿到公民信息。

案例中，镜像为嫌疑人陈某的笔记本电脑硬盘镜像，虚拟机为该网站后台服务器，请对镜像和服务器进行分析，固定嫌疑人在离职前后的可疑痕迹。

### 检材：

##### Centos7 64位的虚拟机文件一份
很惊喜地发现有一份快照（比武起点）

##### 犯罪嫌疑人笔记本电脑E01镜像一份

### 题目

##### 1.分别列出服务器的系统类型，版本号，定时任务情况；（5分）

打开虚拟机发现需要密码，直接绕掉

顺便记录一下Centos6和Centos7的密码绕过方法：
###### Centos6密码绕过
```
启动时任意键暂停启动        
按a键进入编辑模式 
按S键进入单用户模式
passwd root
exit
reboot
```

###### Centos7密码绕过
```
方法一：

启动时任意键暂停启动        
按e键进入编辑模式        
将光标移动到linux16开始的行，将ro改为rw init=/sysroot/bin/sh       
按Ctrl-x启动        
chroot /sysroot 
LANG=en（如果出现乱码）
passwd root        
touch /.autorelabel         # (如果你系统没有开启selinux，那么可以不做这一步)        
exit         
reboot         

方法二：

启动时任意键暂停启动
按e键进入编辑模式
将光标移动到linux16开始的行，添加内核参数rd.break
按Ctrl-x启动
mount -o remount,rw /sysroot
chroot /sysroot
LANG=en（如果出现乱码）
passwd root
touch /.autorelabel
exit
reboot 
```

说实话，我没有绕，直接尝试`root:12456`组合就成功进去了。。。

查看Linux系统类型、详细版本号：
```
cat /proc/version

cat /etc/redhat-release

uname -a

uname -r

cat /ertc/issue
```

linux版本号相关知识：

3.10.0-693.el7.x86_64
3：目前发布的主版本号
10：次版本号，偶数表示稳定版本；奇数表示开发中版本。
0：错误修补的次数
693：表示当前版本的第五次微调patch
el：表示多处理器

crontab相关命令：

crontab -h： 查看帮助文档
crontab -uroot 指定用户
crontab -uroot -l 查看root用户的所有crontab

crontab格式详解：
分钟（0-59） | 小时（0-23） | 日期（1-31）  | 月份（1-12） | 周（0-6，0表示周日） | 执行的命令

中间以空格或者是tab为界。

`
crontab -uroot -l
0,30 8-20 * * * chmod 755 /var/opt/gl/bac.sh
1,31 8-20 * * * /var/opt/dl/bac.sh
`
##### 解答：

系统类型是：Centos7 64位
版本号是：3.10.0-693.el7.x86_64
定时任务情况是：每天的8点到12点0分和30分改变/var/opt/gl/bac.sh的权限为755,1分和31分执行该文件。

##### 2分别列出运行的网站服务类型，监听端口，网页文件所在位置，网站访问日志位置；（5分）

`
netstat -antp
netstat -ano
`

![upload successful](/images/pasted-11.png)

nginx的默认配置文件是：/etc/nginx/nginx.conf
nginx的默认子配置文件是：/etc/nginx/conf.d/*.conf

###### 可以在默认配置文件中查看子配置文件的位置，可以在子配置文件中查看`监听端口号、域名（服务名）、访问日志位置、网站根目录、网站首页文件`

`
less /etc/nginx/conf.d/*.conf
`
![upload successful](/images/pasted-12.png)

然而实际上答案不是这个，因为：
1.当你访问/usr/share/nginx/之后发现，里面只有两个nginx的默认文件；
2.参考上面的crontab之后，会发现这个目录有古怪，进去发现是一个网站的根目录，自然让人生疑。
3.使用`ps -ef | grep nginx`查看nginx进程调用的文件时发现，nginx没有使用默认的配置文件，而是另外选了`/etc/nginx/nginx.conf`


![upload successful](/images/pasted-13.png)

然后查看该配置文件，发现其中包含了另一个配置文件`/etc/nginx/conf.site.d/mm.conf`


![upload successful](/images/pasted-14.png)

查看 mm.conf：


![upload successful](/images/pasted-15.png)

其实这题也是做到后面第5题才发现的错误，大意疏忽了。


##### 解答：

网站服务类型是：nginx
监听端口是：80
网页文件所在位置是：/var/opt/gl/
网站访问日志：/var/log/nginx/access.log


##### 3.分别列出网站服务器中运行什么数据库，数据库配置文件所在位置，监听端口，有哪些账号，密码分别是什么？（10分）

`netstat -antp`查看当前使用的端口情况。

![upload successful](/images/pasted-11.png)

`my.cnf`是mysql启动时加载的配置文件，一般会放在mysql的安装目录中，用户也可以放在其他目录加载。
运用 `find / -name my.cnf`可以列出所有的数据库配置文件。


查看当前运行的mysql进程是否使用指定配置文件：`
ps -aux | grep mysql
`或者是`
ps -ef | grep mysql
查看进程使用的文件
`

如果没有设置使用指定目录的my.cnf，mysql启动时会读取安装目录根目录及默认目录下的my.cnf文件。
查看mysql默认读取my.cnf的目录：`
mysql --help | grep 'my.cnf
`

如果指定目录下都没有配置文件，那就是加载mysql的时候没有使用配置文件。


因为不知道本地数据库的密码，所以我们更换登录配置文件，使我们能够以无密码登录的状态登录进去。
```
systemctl stop mysqld

mysqld --user=root --skip-grant-tables &

mysql -uroot -p

#mysql5.7以下版本
UPDATE mysql.user SET Password=PASSWORD('123456') where USER='root';

#mysql5.7
UPDATE mysql.user SET authentication_string=PASSWORD('123456') where USER='root';
#建议desc user；查看是password还是authenticatoni_string

flush privileges;

exit

systemctl restart mysqld

mysql -uroot -p
```

###### 查看mysql版本号：

在终端下：mysql -V
在终端下：mysql --help | grep Distrib
在mysql中：mysql> status;
在mysql中：select version();

###### 三种重启命令：
/etc/init.d/mysqld restart
systemctl restart mysql
service mysqld restart

###### /etc/shadow文件

口令：
如果为空，则对应用户没有口令，登录时不需要口令；
星号代表帐号被锁定；
双叹号表示这个密码已经过期了；
\$6\$开头的，表明是用SHA-512加密；
\$1\$表明是用MD5加密；
\$2\$ 是用Blowfish加密；
\$5\$ 是用 SHA-256加密；


成功进入数据库后，直接输入
```
use mysql;
select user,host,password from user;
```

![upload successful](/images/pasted-16.png)

C6B2B8EC628390A22B99AB0609E5E70A0F962E9F

23AE809DDACAF96AF0FD78ED04B6A265E05AA257 

使用MD5爆破得：
root：123
sae_user：ming

##### 解答：
网站服务器运行数据库：mysqld
数据库配置文件所在位置：/etc/my.cnf
监听端口：3306
账号和密码是：root : 123、sae_user : ming

##### 4.尝试启动访问该网站并固定网站首页，简述该网站登录密码的获取方式。（10分）

`ifconfig`查看Centos的IP地址为：192.168.213.136
由上可知：nginx的监听端口是80。
直接在宿主机浏览器输入：192.168.213.136:80
如下图：

![upload successful](/images/pasted-17.png)

查询数据库mysite：
破解MD5值得到`admin：admin`
尝试登陆：


![upload successful](/images/pasted-18.png)

##### 解答：
利用之前解密的root账户登录进数据库，在mysite库中获取admin密码为admin，登录成功。


##### 5.嫌疑人使用的笔记本中，能够确认的与本次入侵相关的痕迹最早是在什么时间？（5分）

使用取证大师：
其实也是可以尝试仿真，qemu格式转化，反正是备赛，权当复习一下。但是火眼仿真是真的香。

恢复虚拟机快照，使用last 查看服务器最近登录记录，近期均为本机登录，使用lastb查看登录失败记录，未见异常。

![upload successful](/images/pasted-47.png)

![upload successful](/images/pasted-48.png)

注意：是从嫌疑人的电脑中，实际上查看嫌疑人的电脑的浏览记录中可以翻到相关的写马记录：



##### 解答：
最早的时候是2018年1月4号15:37:21。

##### 6.一个疑似被用于入侵的存储设备在现场没被找到，列出可能名称和序列号。（5分）

根据取证大师里的USB设备连接相关的记录可以发现：
该计算机曾经连接过两个可疑的USB大储量设备，结合陈某是6月24号左右离职的，所以，大概率是一个金士顿的USB移动存储设备。

![upload successful](/images/pasted-19.png)

##### 解答：
可能的设备名称和对应的序列号是`Kingston DataTraveler 2.0 USB Device`和`1ee045c2-784b-11e7-a2f6-000c29f17239`

##### 7．服务器中history命令没有响应，分析其可能原因并列出相关线索。（10分）

因为之前看到crontab中的命令，执行的命令中有一条是将history命令记录文件移动到`/var/opt/gl/save`下的隐藏文件`.his备份`中。


![upload successful](/images/pasted-20.png)


![upload successful](/images/pasted-35.png)

注意到权限问题，这是值得思考

查看备份文件：

![upload successful](/images/pasted-21.png)

##### 解答：
因为嫌疑人已经把历史命令备份到了相关的文件中，线索如上。


##### 8.嫌疑人是否通过命令行方式管理过数据库？找到相关线索。（5分）

通过快照恢复之后，查询数据库是否启用mysql>show variables like 'log_bin'：

![upload successful](/images/pasted-37.png)
很好，没有开启。

查看数据库配置文件：

![upload successful](/images/pasted-36.png)

查看导出的honglian.log可以看到：从数据库密码于一些基本路径等推断为服务器被转移的历史命令记录，并发现曾导出数据库数据至/mysite.sql，并且嫌疑人曾以命令行管理过数据库。

另外：Honglian.log修改时间为6月24日12:57分，推测转移时间为中午。

![upload successful](/images/pasted-44.png)

![upload successful](/images/pasted-40.png)

![upload successful](/images/pasted-41.png)

![upload successful](/images/pasted-43.png)

##### 解答：
嫌疑人曾经使用过命令行的方式管理过数据库。

##### 9.分析E盘中文件的可能来源，并计算其md5值。（10分）

首先发现了E盘是bitlocker加密的，通过搜寻的秘钥直接可以解密，解密之后，挂载，发现只有一个文件夹，里面内容有两个。

![upload successful](/images/pasted-22.png)

其中，MD5值为：

![upload successful](/images/pasted-23.png)

查看服务器根目录下的mysite.sql,计算md5哈希值，与嫌疑人笔记本电脑中的mysite.sql一致，遂确认嫌疑人笔记本电脑中的mysite.sql来源为服务器。

![upload successful](/images/pasted-50.png)

##### 解答：
mysite.sql：DC6DC637E56EAF805636467A777D4632
hongliang.log：A7CD80DFFD896085F4BE9FA104710981

mysite.sql虽然在站点文件夹中发现该文件，但是从站点文件夹中拷贝的详细过程有待深究。
hongliang可以从上一题中的备份history文件中得到来源线索，是从移动设备中拷出来的。

尝试利用`NTFS log tracker`查看该磁盘操作日志，但是没有在`$extend`下找到`$J`，作罢。
附上`NTFS log tracker`的使用指导：

http://forensicinsight.org/wp-content/uploads/2013/06/F-INSIGHT-NTFS-Log-TrackerEnglish.pdf

##### 10.服务器中存在哪些恶意程序，分别是如何上传至服务器的。 （15分）

在站点文件夹中，有两个可执行文件十分显眼：

![upload successful](/images/pasted-24.png)

一个是陈某留下的备份sh脚本；另一个查看可以发现在头部多了一个php语句：

![upload successful](/images/pasted-25.png)
遂怀疑是拼接一句话木马，发现nginx的访问日志`/var/log/nginx/access.log`被清空了。

对虚拟机快照恢复，再次访问该日志文件：

![upload successful](/images/pasted-28.png)

对`footer.php`查询：

![upload successful](/images/pasted-29.png)

对第一条命令中的参数base64解密：

![upload successful](/images/pasted-32.png)


![upload successful](/images/pasted-33.png)

很明显，写入一句话木马到c.php。

对第三条语句中的参数base64解密：

![upload successful](/images/pasted-34.png)

在hlj.php中写入一句话木马。

第五题的答案迎刃而解。

对`heb.php`查询：

![upload successful](/images/pasted-30.png)

发现对数据库中的特定库中的特定表select出来了。

另外，对网站进行复现还原，也可以直接定位`heb.php`的详细作用----用于数据库的增删改查。

![upload successful](/images/pasted-54.png)

![upload successful](/images/pasted-66.png)

在嫌疑人xise菜刀同目录下发现heb.php,校验md5哈希值与服务器上脚本一致，推断通过xise菜刀软件上传。

![upload successful](/images/pasted-56.png)

同样值得注意的是：`footer.php`是命令执行文件，根据web access日志和服务器历史命令日志和文件拥有者是root这三点可以推断是陈某运维时利用root账户上传的，一直存在于服务器上。而恶意脚本`hlj.php`就是利用`footer.php`生成的。

在取证大师中，对C盘进行卷影分析，恢复出了4个C盘记录，在当前和分析的桌面目录下找到了相关的文件：

![upload successful](/images/pasted-27.png)

![upload successful](/images/pasted-26.png)

XISE菜刀是webshell管理工具,jsc.mdb是菜刀的access数据库文件；heb.php是管理数据库的php文件。

对xise菜刀的还原：
发现嫌疑人存在对192.168.50.134的webshell hlj.php的连接记录：

![upload successful](/images/pasted-59.png)

SAMInside是提权工具。可以通过此工具得到登录用户的NTLM哈希值，随后爆破可得密码。

注意：实际上可以直接使用D盾对整个网站的源码进行扫描，可以很清楚看见恶意文件为footer.php和hlj.php：

![upload successful](/images/pasted-60.png)

![upload successful](/images/pasted-61.png)


##### 解答：

恶意文件有：

hlj.php：通过footer.php写入，一句话木马。

c.php：通过footer.php写入，一句话木马。

heb.php：数据库管理脚本，推测为嫌疑人使用xise菜刀连接hlj.php上传。

footer.php：命令执行，因为文件拥有者是root，怀疑是陈某运维时利用root账户上传的。



##### 11.嫌疑人是否通过恶意程序从服务器端获取了数据库中的数据，固定相关线索。（10分）


![upload successful](/images/pasted-31.png)

根据access.log可以清楚地得到，陈某利用heb.php文件对网站数据库中数据进行获取。

查看access文件，发现存在大量192.168.50.133连接hlh.php记录，且UA信息与其他访问不同，推断为xise菜刀连接记录，根据mysite.sql文件创建时间推断嫌疑人与15:53分使用xise菜刀获取数据库数据文件。在17:45分出现连接heb.php记录。

![upload successful](/images/pasted-52.png)

![upload successful](/images/pasted-53.png)

##### 解答：
是，嫌疑人通过heb.php获取了数据库中的mysite库中的contract表的数据。

![upload successful](/images/pasted-31.png)

##### 12.嫌疑人本次删除了多少条数据库记录，可能是什么时间，通过何种方式删除的。（10分）

利用嫌疑人电脑里面的`mysite.sql`还原出数据库书籍文件，对比现有数据库文件中的数据，可以发现表contract中数据缺失49条。

![upload successful](/images/pasted-39.png)

![upload successful](/images/pasted-62.png)

并且分析嫌疑人的浏览器记录，发现url记录与服务器access.log对应：

![upload successful](/images/pasted-63.png)

![upload successful](/images/pasted-64.png)

嫌疑人在6月24日17:45左右连接heb.php对表contratc进行操作。推断使用heb.php删除数据。

##### 解答：
删除了49条数据，可能时间是6月24日17:45左右，通过heb.php脚本的方式管理数据。



### 案件时间线：

##### 2018年6月24日中午
嫌疑人使用服务器连接个人usb存储设备将.bash_history文件转移至存储设备并保存为honglian.log，并将footer.php木马文件上传至服务器web目录。Honglian.log最后被转移到嫌疑人笔记本加密盘E盘中

##### 2018年6月24日15:30-16:00
电脑设置了计划任务进行.bash_history转移

##### 2018年6月24日16:01
计划任务将最后的.bash_history转移

##### 2018年6月24日15:52分左右
嫌疑人使用webshell footer.php生成木马文件hlj.php

##### 2018年6月24日15:50-17:45
嫌疑人使用xise菜刀连接webshell,下载数据库数据文件mysite.sql,上传数据库管理脚本heb.php，mysite.sql存储于嫌疑人笔记本电脑加密盘E盘中

##### 2018年6月24日17:45-17:50

嫌疑人使用heb.php脚本删除mysite数据库中contract表数据49条





